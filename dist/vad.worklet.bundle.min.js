(()=>{"use strict";var t,e;(e=t||(t={})).AudioFrame="AUDIO_FRAME",e.SpeechStart="SPEECH_START",e.VADMisfire="VAD_MISFIRE",e.SpeechEnd="SPEECH_END",e.SpeechStop="SPEECH_STOP";const s=["error","debug","warn"].reduce(((t,e)=>(t[e]=function(t){return(...e)=>{console[t]("[VAD]",...e)}}(e),t)),{});class i{options;inputBuffer;constructor(t){this.options=t,t.nativeSampleRate<16e3&&s.error("nativeSampleRate is too low. Should have 16000 = targetSampleRate <= nativeSampleRate"),this.inputBuffer=[]}process=t=>{const e=[];for(this.fillInputBuffer(t);this.hasEnoughDataForFrame();){const t=this.generateOutputFrame();e.push(t)}return e};stream=async function*(t){for(this.fillInputBuffer(t);this.hasEnoughDataForFrame();){const t=this.generateOutputFrame();yield t}};fillInputBuffer(t){for(const e of t)this.inputBuffer.push(e)}hasEnoughDataForFrame(){return this.inputBuffer.length*this.options.targetSampleRate/this.options.nativeSampleRate>=this.options.targetFrameSize}generateOutputFrame(){const t=new Float32Array(this.options.targetFrameSize);let e=0,s=0;for(;e<this.options.targetFrameSize;){let i=0,r=0;for(;s<Math.min(this.inputBuffer.length,(e+1)*this.options.nativeSampleRate/this.options.targetSampleRate);){const t=this.inputBuffer[s];void 0!==t&&(i+=t,r++),s++}t[e]=i/r,e++}return this.inputBuffer=this.inputBuffer.slice(s),t}}class r extends AudioWorkletProcessor{resampler;_initialized=!1;_stopProcessing=!1;options;constructor(e){super(),this.options=e.processorOptions,this.port.onmessage=e=>{e.data.message===t.SpeechStop&&(this._stopProcessing=!0)},this.init()}init=async()=>{s.debug("initializing worklet"),this.resampler=new i({nativeSampleRate:sampleRate,targetSampleRate:16e3,targetFrameSize:this.options.frameSamples}),this._initialized=!0,s.debug("initialized worklet")};process(e,s,i){if(this._stopProcessing)return!1;const r=e[0][0];if(this._initialized&&r instanceof Float32Array){const e=this.resampler.process(r);for(const s of e)this.port.postMessage({message:t.AudioFrame,data:s.buffer},[s.buffer])}return!0}}registerProcessor("vad-helper-worklet",r)})();